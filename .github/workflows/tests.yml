name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    # Run on all pull requests regardless of target branch
    branches: [ '**' ]

jobs:
  test-linux:
    name: Linux - ${{ matrix.compiler }} - ${{ matrix.build_type }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-11, gcc-12, clang-14, clang-15]
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build lcov

    - name: Install GCC 11
      if: matrix.compiler == 'gcc-11'
      run: |
        sudo apt-get install -y g++-11
        echo "CC=gcc-11" >> $GITHUB_ENV
        echo "CXX=g++-11" >> $GITHUB_ENV

    - name: Install GCC 12
      if: matrix.compiler == 'gcc-12'
      run: |
        sudo apt-get install -y g++-12
        echo "CC=gcc-12" >> $GITHUB_ENV
        echo "CXX=g++-12" >> $GITHUB_ENV

    - name: Install Clang 14
      if: matrix.compiler == 'clang-14'
      run: |
        sudo apt-get install -y clang-14
        echo "CC=clang-14" >> $GITHUB_ENV
        echo "CXX=clang++-14" >> $GITHUB_ENV

    - name: Install Clang 15
      if: matrix.compiler == 'clang-15'
      run: |
        sudo apt-get install -y clang-15
        echo "CC=clang-15" >> $GITHUB_ENV
        echo "CXX=clang++-15" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build build --parallel

    - name: Run CTest
      working-directory: build
      run: ctest --output-on-failure --verbose

  test-windows:
    name: Windows - ${{ matrix.compiler }} - ${{ matrix.build_type }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [msvc, gcc, clang]
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up MSVC
      if: matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Set up GCC (MinGW)
      if: matrix.compiler == 'gcc'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-ninja

    - name: Set up Clang
      if: matrix.compiler == 'clang'
      run: |
        choco install llvm ninja -y
        $llvmBin = "C:\Program Files\LLVM\bin"
        echo "PATH=$llvmBin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CC=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CXX=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Set up MSVC environment (Clang)
      if: matrix.compiler == 'clang'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        cmake -B build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Configure CMake (MinGW)
      if: matrix.compiler == 'gcc'
      shell: msys2 {0}
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Configure CMake (Clang)
      if: matrix.compiler == 'clang'
      run: |
        cmake -B build `
          -G Ninja `
          -DCMAKE_C_COMPILER=clang-cl `
          -DCMAKE_CXX_COMPILER=clang-cl `
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Build (MSVC/Clang)
      if: matrix.compiler != 'gcc'
      run: cmake --build build --parallel

    - name: Build (MinGW)
      if: matrix.compiler == 'gcc'
      shell: msys2 {0}
      run: cmake --build build --parallel

    - name: Run tests (MSVC/Clang)
      if: matrix.compiler != 'gcc'
      working-directory: build
      run: ctest --output-on-failure --verbose

    - name: Run tests (MinGW)
      if: matrix.compiler == 'gcc'
      shell: msys2 {0}
      working-directory: build
      run: ctest --output-on-failure --verbose

  test-macos:
    name: macOS - Clang - ${{ matrix.build_type }}
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja lcov

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build build --parallel

    - name: Run CTest
      working-directory: build
      run: ctest --output-on-failure --verbose

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build lcov g++-11 gcc-11

    - name: Set up GCC for coverage
      run: |
        echo "CC=gcc-11" >> $GITHUB_ENV
        echo "CXX=g++-11" >> $GITHUB_ENV
        echo "GCOV=/usr/bin/gcov-11" >> $GITHUB_ENV

    - name: Configure with coverage
      run: |
        cmake -B build_coverage \
          -G Ninja \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=Coverage \
          -DENABLE_COVERAGE=ON \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build with coverage
      run: cmake --build build_coverage --parallel

    - name: Run tests
      working-directory: build_coverage
      run: ctest --output-on-failure

    - name: Generate coverage report
      working-directory: build_coverage
      run: |
        lcov --gcov-tool "$GCOV" --ignore-errors mismatch,inconsistent --capture --directory . --output-file coverage.info
        lcov --gcov-tool "$GCOV" --ignore-errors mismatch,inconsistent --remove coverage.info \
          '/usr/*' \
          '*/build_coverage/_deps/*' \
          '*/tests/*' \
          --output-file coverage_filtered.info
        lcov --gcov-tool "$GCOV" --list coverage_filtered.info

    - name: Generate HTML coverage report
      working-directory: build_coverage
      run: |
        genhtml coverage_filtered.info --output-directory coverage_html

    - name: Extract coverage percentage
      id: coverage
      working-directory: build_coverage
      run: |
        COVERAGE=$(lcov --gcov-tool "$GCOV" --summary coverage_filtered.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage: $COVERAGE%"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./build_coverage/coverage_filtered.info
        fail_ci_if_error: false
        verbose: true

    - name: Update docs/coverage directory
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        rm -rf docs/coverage/*
        cp -r build_coverage/coverage_html/* docs/coverage/

    - name: Update README badge
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        COVERAGE="${{ steps.coverage.outputs.percentage }}"
        sed -i "s/coverage-[0-9.]*%25/coverage-${COVERAGE}%25/g" README.md

    - name: Commit and push coverage report
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/coverage/ README.md

        # Only proceed if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "Update coverage report to ${{ steps.coverage.outputs.percentage }}% [skip ci]"

          # Retry push with rebase up to 5 times to handle race conditions
          for i in {1..5}; do
            if git pull --rebase origin main && git push origin main; then
              echo "Successfully pushed coverage report"
              break
            else
              if [ $i -eq 5 ]; then
                echo "Failed to push after 5 attempts"
                exit 1
              fi
              echo "Push failed, retrying in 2 seconds... (attempt $i/5)"
              sleep 2
            fi
          done
        fi

  clang-tidy:
    name: Clang-Tidy Static Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build clang-tidy

    - name: Configure CMake with compile commands
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Run clang-tidy on headers
      run: |
        echo "Running clang-tidy on header files..."
        clang-tidy -p build include/*.hpp --header-filter='include/.*' 2>&1 | tee clang_tidy_headers.txt || true

    - name: Run clang-tidy on tests
      run: |
        echo "Running clang-tidy on test files..."
        clang-tidy -p build tests/*.cpp --header-filter='(include/|tests/).*' 2>&1 | tee clang_tidy_tests.txt || true

    - name: Generate HTML report
      run: |
        mkdir -p docs/clang-tidy
        cat > docs/clang-tidy/index.html <<'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Clang-Tidy Report - JazzyIndex</title>
            <style>
                body { font-family: monospace; margin: 20px; background: #f5f5f5; }
                .header { background: #2c3e50; color: white; padding: 20px; margin: -20px -20px 20px -20px; }
                .section { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                h1 { margin: 0; }
                h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
                pre { background: #ecf0f1; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
                .warning { color: #f39c12; }
                .error { color: #e74c3c; }
                .note { color: #3498db; }
                .timestamp { color: #95a5a6; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üîç Clang-Tidy Static Analysis Report</h1>
                <p class="timestamp">Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
            </div>

            <div class="section">
                <h2>Headers (include/*.hpp)</h2>
                <pre>
        EOF
        cat clang_tidy_headers.txt >> docs/clang-tidy/index.html
        cat >> docs/clang-tidy/index.html <<'EOF'
                </pre>
            </div>

            <div class="section">
                <h2>Tests (tests/*.cpp)</h2>
                <pre>
        EOF
        cat clang_tidy_tests.txt >> docs/clang-tidy/index.html
        cat >> docs/clang-tidy/index.html <<'EOF'
                </pre>
            </div>

            <div class="section">
                <h2>Summary</h2>
                <p>This report is automatically generated by CI on every push to main.</p>
                <p>Warnings and errors shown above should be addressed to maintain code quality.</p>
            </div>
        </body>
        </html>
        EOF

    - name: Commit and push clang-tidy report
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/clang-tidy/

        # Only proceed if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "Update clang-tidy report [skip ci]"

          # Retry push with rebase up to 5 times to handle race conditions
          for i in {1..5}; do
            if git pull --rebase origin main && git push origin main; then
              echo "Successfully pushed clang-tidy report"
              break
            else
              if [ $i -eq 5 ]; then
                echo "Failed to push after 5 attempts"
                exit 1
              fi
              echo "Push failed, retrying in 2 seconds... (attempt $i/5)"
              sleep 2
            fi
          done
        fi

  sanitizers-linux:
    name: Sanitizers - Linux - ${{ matrix.compiler }} - ${{ matrix.sanitizer }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-12, clang-15]
        sanitizer: [address, undefined]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build

    - name: Set up GCC 12
      if: matrix.compiler == 'gcc-12'
      run: |
        sudo apt-get install -y g++-12
        echo "CC=gcc-12" >> $GITHUB_ENV
        echo "CXX=g++-12" >> $GITHUB_ENV

    - name: Set up Clang 15
      if: matrix.compiler == 'clang-15'
      run: |
        sudo apt-get install -y clang-15
        echo "CC=clang-15" >> $GITHUB_ENV
        echo "CXX=clang++-15" >> $GITHUB_ENV

    - name: Configure with ${{ matrix.sanitizer }} sanitizer
      run: |
        SANITIZER_FLAG="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -g"
        cmake -B build_sanitizer \
          -G Ninja \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="${SANITIZER_FLAG}" \
          -DCMAKE_EXE_LINKER_FLAGS="${SANITIZER_FLAG}" \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build with sanitizer
      run: cmake --build build_sanitizer --parallel

    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      working-directory: build_sanitizer
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
      run: ctest --output-on-failure --verbose

  sanitizers-windows:
    name: Sanitizers - Windows - ${{ matrix.compiler }} - ${{ matrix.sanitizer }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [msvc]
        sanitizer: [address]
        # Note: MSVC and Clang on Windows support ASAN well, but UBSAN and TSAN have limited support

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up MSVC
      if: matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Set up Clang
      if: matrix.compiler == 'clang'
      run: |
        choco install llvm ninja -y
        $llvmBin = "C:\Program Files\LLVM\bin"
        echo "PATH=$llvmBin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CC=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CXX=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Set up MSVC environment (Clang)
      if: matrix.compiler == 'clang'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure with AddressSanitizer (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        cmake -B build_sanitizer `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Debug `
          -DCMAKE_CXX_FLAGS="/fsanitize=address /Zi" `
          -DCMAKE_EXE_LINKER_FLAGS="/fsanitize=address" `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Configure with AddressSanitizer (Clang)
      if: matrix.compiler == 'clang'
      run: |
        cmake -B build_sanitizer `
          -G Ninja `
          -DCMAKE_C_COMPILER=clang-cl `
          -DCMAKE_CXX_COMPILER=clang-cl `
          -DCMAKE_BUILD_TYPE=Debug `
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g" `
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Build with sanitizer
      run: cmake --build build_sanitizer --parallel

    - name: Run tests with AddressSanitizer
      working-directory: build_sanitizer
      env:
        ASAN_OPTIONS: detect_leaks=0:windows_hook_rtl_allocators=true
      run: ctest --output-on-failure --verbose
