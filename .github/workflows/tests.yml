name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-linux:
    name: Linux - ${{ matrix.compiler }} - ${{ matrix.build_type }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-11, gcc-12, clang-14, clang-15]
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build lcov

    - name: Install GCC 11
      if: matrix.compiler == 'gcc-11'
      run: |
        sudo apt-get install -y g++-11
        echo "CC=gcc-11" >> $GITHUB_ENV
        echo "CXX=g++-11" >> $GITHUB_ENV

    - name: Install GCC 12
      if: matrix.compiler == 'gcc-12'
      run: |
        sudo apt-get install -y g++-12
        echo "CC=gcc-12" >> $GITHUB_ENV
        echo "CXX=g++-12" >> $GITHUB_ENV

    - name: Install Clang 14
      if: matrix.compiler == 'clang-14'
      run: |
        sudo apt-get install -y clang-14
        echo "CC=clang-14" >> $GITHUB_ENV
        echo "CXX=clang++-14" >> $GITHUB_ENV

    - name: Install Clang 15
      if: matrix.compiler == 'clang-15'
      run: |
        sudo apt-get install -y clang-15
        echo "CC=clang-15" >> $GITHUB_ENV
        echo "CXX=clang++-15" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build build --parallel

    - name: Run CTest
      working-directory: build
      run: ctest --output-on-failure --verbose

  test-windows:
    name: Windows - ${{ matrix.compiler }} - ${{ matrix.build_type }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [msvc, gcc, clang]
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up MSVC
      if: matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Set up GCC (MinGW)
      if: matrix.compiler == 'gcc'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-ninja

    - name: Set up Clang
      if: matrix.compiler == 'clang'
      run: |
        choco install llvm ninja -y
        $llvmBin = "C:\Program Files\LLVM\bin"
        echo "PATH=$llvmBin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CC=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CXX=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Set up MSVC environment (Clang)
      if: matrix.compiler == 'clang'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        cmake -B build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Configure CMake (MinGW)
      if: matrix.compiler == 'gcc'
      shell: msys2 {0}
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Configure CMake (Clang)
      if: matrix.compiler == 'clang'
      run: |
        cmake -B build `
          -G Ninja `
          -DCMAKE_C_COMPILER=clang-cl `
          -DCMAKE_CXX_COMPILER=clang-cl `
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Build (MSVC/Clang)
      if: matrix.compiler != 'gcc'
      run: cmake --build build --parallel

    - name: Build (MinGW)
      if: matrix.compiler == 'gcc'
      shell: msys2 {0}
      run: cmake --build build --parallel

    - name: Run tests (MSVC/Clang)
      if: matrix.compiler != 'gcc'
      working-directory: build
      run: ctest --output-on-failure --verbose

    - name: Run tests (MinGW)
      if: matrix.compiler == 'gcc'
      shell: msys2 {0}
      working-directory: build
      run: ctest --output-on-failure --verbose

  test-macos:
    name: macOS - Clang - ${{ matrix.build_type }}
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja lcov

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build
      run: cmake --build build --parallel

    - name: Run CTest
      working-directory: build
      run: ctest --output-on-failure --verbose

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build lcov g++-11 gcc-11

    - name: Set up GCC for coverage
      run: |
        echo "CC=gcc-11" >> $GITHUB_ENV
        echo "CXX=g++-11" >> $GITHUB_ENV
        echo "GCOV=/usr/bin/gcov-11" >> $GITHUB_ENV

    - name: Configure with coverage
      run: |
        cmake -B build_coverage \
          -G Ninja \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=Coverage \
          -DENABLE_COVERAGE=ON \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build with coverage
      run: cmake --build build_coverage --parallel

    - name: Run tests
      working-directory: build_coverage
      run: ctest --output-on-failure

    - name: Generate coverage report
      working-directory: build_coverage
      run: |
        lcov --gcov-tool "$GCOV" --ignore-errors mismatch,inconsistent --capture --directory . --output-file coverage.info
        lcov --gcov-tool "$GCOV" --ignore-errors mismatch,inconsistent --remove coverage.info \
          '/usr/*' \
          '*/build_coverage/_deps/*' \
          '*/tests/*' \
          --output-file coverage_filtered.info
        lcov --gcov-tool "$GCOV" --list coverage_filtered.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./build_coverage/coverage_filtered.info
        fail_ci_if_error: false
        verbose: true

  clang-tidy:
    name: Clang-Tidy Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build clang-tidy

    - name: Configure CMake with compile commands
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Run clang-tidy on headers
      run: |
        echo "Running clang-tidy on header files..."
        clang-tidy -p build include/*.hpp --header-filter='include/.*'

    - name: Run clang-tidy on tests
      run: |
        echo "Running clang-tidy on test files..."
        clang-tidy -p build tests/*.cpp --header-filter='(include/|tests/).*' || true

  sanitizers-linux:
    name: Sanitizers - Linux - ${{ matrix.compiler }} - ${{ matrix.sanitizer }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-12, clang-15]
        sanitizer: [address, undefined, thread]
        exclude:
          # Thread sanitizer doesn't work well with some compilers in CI
          - compiler: gcc-12
            sanitizer: thread

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build

    - name: Set up GCC 12
      if: matrix.compiler == 'gcc-12'
      run: |
        sudo apt-get install -y g++-12
        echo "CC=gcc-12" >> $GITHUB_ENV
        echo "CXX=g++-12" >> $GITHUB_ENV

    - name: Set up Clang 15
      if: matrix.compiler == 'clang-15'
      run: |
        sudo apt-get install -y clang-15
        echo "CC=clang-15" >> $GITHUB_ENV
        echo "CXX=clang++-15" >> $GITHUB_ENV

    - name: Configure with ${{ matrix.sanitizer }} sanitizer
      run: |
        SANITIZER_FLAG="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -g"
        cmake -B build_sanitizer \
          -G Ninja \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="${SANITIZER_FLAG}" \
          -DCMAKE_EXE_LINKER_FLAGS="${SANITIZER_FLAG}" \
          -DBUILD_TESTS=ON \
          -DBUILD_BENCHMARKS=OFF

    - name: Build with sanitizer
      run: cmake --build build_sanitizer --parallel

    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      working-directory: build_sanitizer
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
        TSAN_OPTIONS: second_deadlock_stack=1
      run: ctest --output-on-failure --verbose

  sanitizers-windows:
    name: Sanitizers - Windows - ${{ matrix.compiler }} - ${{ matrix.sanitizer }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [msvc]
        sanitizer: [address]
        # Note: MSVC and Clang on Windows support ASAN well, but UBSAN and TSAN have limited support

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up MSVC
      if: matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Set up Clang
      if: matrix.compiler == 'clang'
      run: |
        choco install llvm ninja -y
        $llvmBin = "C:\Program Files\LLVM\bin"
        echo "PATH=$llvmBin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CC=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "CXX=clang-cl" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Set up MSVC environment (Clang)
      if: matrix.compiler == 'clang'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure with AddressSanitizer (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        cmake -B build_sanitizer `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Debug `
          -DCMAKE_CXX_FLAGS="/fsanitize=address /Zi" `
          -DCMAKE_EXE_LINKER_FLAGS="/fsanitize=address" `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Configure with AddressSanitizer (Clang)
      if: matrix.compiler == 'clang'
      run: |
        cmake -B build_sanitizer `
          -G Ninja `
          -DCMAKE_C_COMPILER=clang-cl `
          -DCMAKE_CXX_COMPILER=clang-cl `
          -DCMAKE_BUILD_TYPE=Debug `
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g" `
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" `
          -DBUILD_TESTS=ON `
          -DBUILD_BENCHMARKS=OFF

    - name: Build with sanitizer
      run: cmake --build build_sanitizer --parallel

    - name: Run tests with AddressSanitizer
      working-directory: build_sanitizer
      env:
        ASAN_OPTIONS: detect_leaks=0:windows_hook_rtl_allocators=true
      run: ctest --output-on-failure --verbose

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build python3 python3-pip python3-venv

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=OFF \
          -DBUILD_BENCHMARKS=ON

    - name: Build benchmarks
      run: cmake --build build --parallel

    - name: Run benchmarks
      working-directory: build
      run: ./jazzy_index_benchmarks --benchmark_min_time=0.1s

    - name: Archive benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: build/jazzy_benchmarks.json
        if-no-files-found: ignore
